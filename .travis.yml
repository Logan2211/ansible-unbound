language: python
services:
  - docker
env:
  # LINTERS
  - >
    toxenv=linters
    image=logan2211/docker-ci
    tag=ubuntu-xenial
    init=/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  # ANSIBLE 2.1 (NEWTON)
  - >
    toxenv=functional_2.1
    image=logan2211/docker-ci
    tag=ubuntu-xenial
    init=/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  - >
    toxenv=functional_2.1
    image=logan2211/docker-ci
    tag=ubuntu-trusty
    init=/sbin/init
    run_opts="-u root --privileged"
  # ANSIBLE 2.2 (OCATA)
  - >
    toxenv=functional_2.2
    image=logan2211/docker-ci
    tag=ubuntu-xenial
    init=/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  - >
    toxenv=functional_2.2
    image=logan2211/docker-ci
    tag=centos-7
    init=/usr/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  # ANSIBLE stable (OSA MASTER)
  - >
    toxenv=functional_stable
    image=logan2211/docker-ci
    tag=ubuntu-xenial
    init=/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  - >
    toxenv=functional_stable
    image=logan2211/docker-ci
    tag=centos-7
    init=/usr/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  - >
    toxenv=functional_stable
    image=logan2211/docker-ci
    tag=opensuse-42.2
    init=/usr/lib/systemd/systemd
    run_opts="-u root --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
before_install:
  - 'docker pull ${image}:${tag}'
script:
  # Create a random file to store the container ID.
  - container_id=$(mktemp)
  - 'docker run --detach --volume="${PWD}":/opt/ansiblerole:rw ${run_opts} ${image}:${tag} "${init}" > "${container_id}"'
  - >
    docker exec "$(cat ${container_id})"
    env toxenv=${toxenv}
    bash -c 'set -ex; \
      pushd /opt/ansiblerole; \
      tox -e ${toxenv}'
notifications:
  slack:
    rooms:
      secure: NZHaWM5nDxbToME+LzgxjNyMomEQQaex1rgjBo36125ZTB6hUZCh7/tUFtc5qtVBG6gOdX9xkqK77jPClD07MtwugBPqAGS6gNhdcalnmIBZnPE4vqRKlM3jrsFQlSd9AOJfTsNiG4NK/q/IJpMcSENovspewsPFQQVd2vHZ0gQtT9IUusbZpDhFpejsuTWOq8sYczWdq8QAmyFlDyknOzQYgWVvXYohFHXw5eFlvO9e0xIXU7vd5MhFwjIe8n1rUzAsiHZrXhW4Fve7I4wQ/yV1GzrCZT8fxu1/YrSRg2eJh6lT7rbFD47TDSh9jLg2a4Nh1wdxXYk50irTKU6l7zaY6PHXd4mAmnWeNkSa6w02BfOsZl8q07AlVCcaD1ttk35x+j+K1MtFXpge7z/S2xl9ygg36F0RoEuQnfIO88F8gnc7hpROCePWQTy9Fl4PFkbEPfyrGpSdQQ64Fpu6mXvs987JEqri0DFdrGXzivs/SIkEpFRVplyHVaDVP6Nv1gmPTX7OheXCCdKNlG9xIQLJGeL6E2Jb5l6xRmaylgi9BjMbRIWM1qz+O4NFDOVW63JqZ+pcDmrQmE9rSYIpUZ2dI4I87evX2OJgZxcMTbltRnDxLJsUGWCiGxfl9CC/KdgcuGY8a57v54b/PH8aRoQd0FPRE00FOron6Hj1TeA=
